# Database Model Design

## 1. Users Table (users)

Store basic user information

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'User unique identifier',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT 'Username',
    email VARCHAR(100) UNIQUE NOT NULL COMMENT 'Email address',
    password_hash VARCHAR(255) NOT NULL COMMENT 'Password hash value',
    nickname VARCHAR(100) COMMENT 'User nickname',
    avatar_url VARCHAR(500) COMMENT 'Avatar URL',
    phone VARCHAR(20) COMMENT 'Phone number',
    status TINYINT DEFAULT 1 COMMENT 'User status: 1-active, 0-disabled',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Creation time',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Update time',
    last_login_at TIMESTAMP NULL COMMENT 'Last login time'
) COMMENT 'User information table';
```

**Field Description:**
- `id`: BIGINT, Primary key, Auto-increment, User unique identifier
- `username`: VARCHAR(50), Unique index, Username, Used for login
- `email`: VARCHAR(100), Unique index, Email address, Used for login and contact
- `password_hash`: VARCHAR(255), Password hash value, Securely store user password
- `nickname`: VARCHAR(100), User nickname, Used for display
- `avatar_url`: VARCHAR(500), User avatar URL
- `phone`: VARCHAR(20), Phone number
- `status`: TINYINT, User status (1-active, 0-disabled)
- `created_at`: TIMESTAMP, Creation time, Default current time
- `updated_at`: TIMESTAMP, Update time, Default current time, Automatically refreshed on update
- `last_login_at`: TIMESTAMP, Last login time, Can be null

## 2. Conversation History Table (conversations)

Store user-AI conversation history

```sql
CREATE TABLE conversations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'Conversation unique identifier',
    user_id BIGINT NOT NULL COMMENT 'Associated user ID',
    title VARCHAR(255) COMMENT 'Conversation title',
    model_name VARCHAR(100) NOT NULL COMMENT 'AI model name used',
    status TINYINT DEFAULT 1 COMMENT 'Conversation status: 1-in progress, 0-ended',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Creation time',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Update time',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
) COMMENT 'Conversation history table';
```

**Field Description:**
- `id`: BIGINT, Primary key, Auto-increment, Conversation unique identifier
- `user_id`: BIGINT, Foreign key, Associated user table ID
- `title`: VARCHAR(255), Conversation title, Can be customized by user or generated by system
- `model_name`: VARCHAR(100), AI model name used (e.g., qwen-vl-max-latest)
- `status`: TINYINT, Conversation status (1-in progress, 0-ended)
- `created_at`: TIMESTAMP, Creation time, Default current time
- `updated_at`: TIMESTAMP, Update time, Default current time, Automatically refreshed on update
- Foreign key constraint: When user is deleted, cascade delete related conversation records
- Indexes: Create indexes on user_id and created_at to improve query performance

## 3. Conversation Messages Table (messages)

Store specific conversation messages

```sql
CREATE TABLE messages (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'Message unique identifier',
    conversation_id BIGINT NOT NULL COMMENT 'Associated conversation ID',
    user_id BIGINT NOT NULL COMMENT 'User ID who sent the message',
    role ENUM('user', 'assistant', 'system') NOT NULL COMMENT 'Message role: user-user, assistant-AI assistant, system-system',
    content_type ENUM('text', 'image_url', 'video_url') NOT NULL DEFAULT 'text' COMMENT 'Content type',
    content TEXT NOT NULL COMMENT 'Message content (stored in JSON format)',
    status TINYINT DEFAULT 1 COMMENT 'Message status: 1-active, 0-deleted',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Creation time',
    FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_conversation_id (conversation_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
) COMMENT 'Conversation messages table';
```

**Field Description:**
- `id`: BIGINT, Primary key, Auto-increment, Message unique identifier
- `conversation_id`: BIGINT, Foreign key, Associated conversation table ID
- `user_id`: BIGINT, Foreign key, Associated user table ID
- `role`: ENUM, Message role (user-user, assistant-AI assistant, system-system)
- `content_type`: ENUM, Content type (text-text, image_url-image URL, video_url-video URL)
- `content`: TEXT, Message content, Stored in JSON format to support multiple content types
- `status`: TINYINT, Message status (1-active, 0-deleted)
- `created_at`: TIMESTAMP, Creation time, Default current time
- Foreign key constraint: When conversation or user is deleted, cascade delete related message records
- Indexes: Create indexes on conversation_id, user_id, and created_at to improve query performance

## 4. API Call Records Table (api_calls)

Record user API usage

```sql
CREATE TABLE api_calls (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'Call record unique identifier',
    user_id BIGINT NOT NULL COMMENT 'User ID who initiated the call',
    conversation_id BIGINT COMMENT 'Associated conversation ID',
    message_id BIGINT COMMENT 'Associated message ID',
    model_name VARCHAR(100) NOT NULL COMMENT 'AI model name called',
    api_endpoint VARCHAR(255) NOT NULL COMMENT 'API endpoint',
    request_content LONGTEXT COMMENT 'Request content',
    response_content LONGTEXT COMMENT 'Response content',
    status_code SMALLINT COMMENT 'HTTP status code',
    request_tokens INT DEFAULT 0 COMMENT 'Tokens used in request',
    response_tokens INT DEFAULT 0 COMMENT 'Tokens used in response',
    total_tokens INT DEFAULT 0 COMMENT 'Total tokens',
    call_duration INT COMMENT 'Call duration (milliseconds)',
    client_ip VARCHAR(45) COMMENT 'Client IP address',
    user_agent TEXT COMMENT 'User agent information',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Creation time',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE SET NULL,
    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_model_name (model_name),
    INDEX idx_created_at (created_at),
    INDEX idx_user_model_date (user_id, model_name, created_at)
) COMMENT 'API call records table';
```

**Field Description:**
- `id`: BIGINT, Primary key, Auto-increment, Call record unique identifier
- `user_id`: BIGINT, Foreign key, Associated user table ID
- `conversation_id`: BIGINT, Foreign key, Associated conversation table ID, Can be null
- `message_id`: BIGINT, Foreign key, Associated message table ID, Can be null
- `model_name`: VARCHAR(100), AI model name called
- `api_endpoint`: VARCHAR(255), API endpoint URL
- `request_content`: LONGTEXT, Request content, Record the complete request sent to API
- `response_content`: LONGTEXT, Response content, Record the complete response returned by API
- `status_code`: SMALLINT, HTTP status code
- `request_tokens`: INT, Tokens used in request
- `response_tokens`: INT, Tokens used in response
- `total_tokens`: INT, Total tokens (request + response)
- `call_duration`: INT, Call duration (milliseconds)
- `client_ip`: VARCHAR(45), Client IP address (supports IPv6)
- `user_agent`: TEXT, User agent information
- `created_at`: TIMESTAMP, Creation time, Default current time
- Foreign key constraint: When user is deleted, cascade delete related call records; when conversation or message is deleted, set to NULL
- Indexes: Create indexes on user_id, model_name, created_at, and composite index user_model_date to improve query performance

## Table Relationship Description

1. **users** ↔ **conversations**: One-to-many relationship, one user can have multiple conversations
2. **conversations** ↔ **messages**: One-to-many relationship, one conversation contains multiple messages
3. **users** ↔ **api_calls**: One-to-many relationship, one user can have multiple API call records
4. **conversations** ↔ **api_calls**: One-to-many relationship, one conversation can have multiple API call records
5. **messages** ↔ **api_calls**: One-to-many relationship, one message can correspond to multiple API call records

## Design Considerations

1. **Security**:
   - Passwords are stored using hash
   - Sensitive information like API keys are not stored in the database
   - Foreign key constraints ensure data integrity

2. **Performance Optimization**:
   - Create indexes on frequently queried fields
   - Use appropriate data types to save storage space
   - Timestamp fields automatically update

3. **Scalability**:
   - Field length reserves expansion space
   - Support multiple content types (text, images, videos)
   - Can record detailed API call information for analysis

4. **Maintainability**:
   - Clear and explicit field naming
   - Add detailed comment descriptions
   - Reasonable table structure design

This database model design meets the requirements mentioned in the system architecture document and can effectively support user management, conversation history records, message storage, and API call monitoring functions.